# 关系查询语言

## 简介

### 查询语言

- 定义

  查询语言是用户用来从数据库中请求获取信息的语言

- 分类

  + 过程化语言

    用户指导系统对数据库执行一系列操作以计算出所需结果

    提供了一组运算，这些运算要么施加于单个关系上，要么施加于一对关系上

    运算结果总是单个的关系，可以模块化的方式来组合几种这样的运算

    关系查询的结果本身也是关系，所以关系运算可施加到查询结果上

    * 最常用的关系运算

    	从单个关系中选出满足一些特定谓词的特殊元组，其结果是一个新关系，它是原始关系的一个子集，例：从 *instructor* 关系中选择满足谓词“工资大于85000美元”的元组，结果是一个新关系，是 *instructor* 的一个子集
    	
    	从一个关系中选出特定的属性（列），其结果是一个只包含那些被选择属性的新关系

    * 连接运算

      把分别来自两个关系的元组对合并成单个元组

  + 非过程化语言

    用户只需描述所需信息，而不用给出获取该信息的具体过程

- 查询语言

  + SQL

  + 关系代数

    过程化的

    定义了在关系上的一组运算，对应于作用在数字上的普通代数运算，如加法、减法等

    关系代数运算通常以一个或两个关系作为输入，返回一个关系作为输出

  + 元组关系演算

    非过程化的
  
  + 域关系演算
  
    非过程化的

## SQL

### 简介

### 包含

- 数据定义语言
- 数据操纵语言
- 完整性
- 视图定义
- 事务控制
- 嵌入式SQL和动态SQL
- 授权

### SQL数据定义

#### 定义内容

- 定义一组关系
- 定义每个关系的信息
  + 每个关系的模式
  + 每个属性的取值类型
  + 完整性约束
  + 每个关系维护的索引集合
  + 每个关系的安全性和权限信息
  + 每个关系在磁盘上的物理存储结构

#### 基本类型

|        类型        |              参数              |                含义                |
| :----------------: | :----------------------------: | :--------------------------------: |
|     $char(n)$      |            指定长度            | 固定长度的字符串（少的会增加空格） |
|    $varchar(n)$    |            最大长度            |          可变长度的字符串          |
|       $int$        |                                |              整数类型              |
|     $smallint$     |                                |             小整数类型             |
|   $numeric(p,d)$   | p 位数字，d 位数字在小数点右边 |               定点数               |
|       $real$       |                                |               浮点数               |
| $double precision$ |                                |            双精度浮点数            |
|     $float(n)$     |            精度为 n            |               浮点数               |

多用 varchar 而不是 char

#### 基本模式定义

##### create table  命令

- 命令格式

  ```mysql
  create table r (
  	A1 D1,
    A2 D2,
    <完整性约束1>,
    <完整性约束2>
  );
  /*
  r 关系名
  Ai 属性名
  Di 属性Ai的域，指定了属性Ai的类型以及可选的约束，用于限制所允许的Ai取值的集合
  */
  ```

- 示例

  ```mysql
  create table department(
  	dept_name varchar(20),
    building varchar(15),
    budget numeric(12, 2),
    primary key (dept_name)
  );
  ```

- 部分完整性约束

  + 主码

    ```mysql
    primary key (Aj1, Aj2)
    ```
  
  	属性 Aj1, Aj2 构成关系的主码
  
  	主码属性必须非空且唯一
  
  + 外码
  
    ```mysql
    foreign key (Ak1, Ak2) references s
    ```
  
    关系中任意元组在属性 (Ak1, Ak2) 上的取值必须对应于关系 s 中某元组在主码属性上的取值
  
  + 非空
  
    ```mysql
    not null
    ```
  
    在该属性上不允许空值

##### drop table 命令

- 命令格式

  ```mysql
  drop table r;
  ```
  
  从数据库中删除关于 r 关系的所有信息

##### alter table 命令

- 命令格式

  ```mysql
  alter table r add A D;
  /*
  r 现有关系的名字
  A 待添加属性的名字
  D 带添加属性的域
  */
  ```

  为已有关系 r 增加属性，关系 r 中所有的元组在新属性上的取值将被设为 null

  ```mysql
  alter table r drop A;
  /*
  r 现有关系的名字
  A 关系 r 的一个属性的名字
  */
  ```

  从关系中去掉属性 A

##### delete 命令

- 命令格式

  ```mysql
  delete from r;
  ```

  从 r 关系中删除所有元组

### SQL 查询

#### 单关系查询

- 示例

  ```mysql
  # 找出所有教师的名字
  select name
  from instructor;
  -- 结果是由属性名为 name 的单个属性构成的关系 
  /*
  SQL 允许在关系以及 SQL 表达式结果中出现重复
  不删除重复 all
  强行删除重复 distinct
  */
  select distinct name
  from instructor;
  ```

- **where** 子句

  选出那些在 **from** 子句的结果关系中满足特定谓词的元组

  ```mysql
  select name
  from instructor
  where salary > 70000 and dept_name = 'Comp. Sci.';
  /*
  where 子句中可以使用逻辑连接词 and、or 和 not
  也包含比较运算符 < <= > >= = !=
  */
  ```

#### 多关系查询

从多个关系中获取信息

- 示例

  ```mysql
  select name, instructor, dept_name, building
  from instructor, department
  where instructor.dept_name = department.dept_name
  ```

#### 命令剖析

- **select** 子句

  用于列出查询结果中所需的属性

- **from** 子句

  查询求值中需要访问的关系列表

  定义了一个在该子句中所列出关系上的笛卡尔积，最好通过下面的迭代过程来理解，此过程可为 **from** 子句的结果关系产生元组

  ```javascript
  for each 元组t1 in 关系r1
  	for each 元组t2 in 关系2
  		...
      for each 元组tm in 关系rm
  		把t1, t2, ..., tm 连接成单个元组 t
      把 t 加入结果关系中
  ```

  笛卡尔积：两个表的笛卡尔积的关系模式中，相同的属性名前加上关系名作为前缀，表示该属性来自哪个关系；对于那些只出现在单个模式中的属性，通常去掉关系名前缀

- **where** 子句

  作用在 **from** 子句中关系的属性上的谓词

- 示例

  ```mysql
  select A1, A2
  from r1, r2
  where P;
  /*
  Ai 一个属性
  ri 一个关系
  P 一个谓词
  运算顺序 from where select
  */
  ```

- 结
  1. 为 **from** 子句中列出的关系产生笛卡尔积
  2. 在步骤1的结果上应用 **where** 子句中指定的谓词
  3. 对于步骤2结果中的每个元组，输出 **select** 子句中指定的属性（或表达式的结果）

### 连接

#### 自然连接








